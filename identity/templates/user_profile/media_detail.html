{% extends 'landing_page.html' %}
{% load static %}
{% load custom_filters %}

{% block profile_header_content %}
{% endblock %}

{% block main_content %}
<style>
    /* Styles remain the same */
</style>

<div class="media-detail-container">
    <a href="{% url 'user_profile:profile' user_id=media.user.id %}">
        {{ media.user.username }}
    </a>
    <div class="media-detail">
        {% if media.file.url|is_video %}
            <video controls class="img-fluid autoplay-video" muted>
                <source src="{{ media.file.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        {% else %}
            <img src="{{ media.file.url }}" alt="media" class="img-fluid">
        {% endif %}
        <div class="description">
            <p>{{ description|safe }}</p>
        </div>
        <div class="actions">
            <!-- Actions remain the same -->
        </div>

        <div class="comments" id="comments-{{ media.id }}">
            <!-- Comments remain the same -->
        </div>
    </div>
</div>

{% if media.user == request.user %}
    <!-- Show the buttons for the media owner -->
    <div class="uploads-section">
        <div class="row row-cols-3 g-4">
            <button type="button" class="btn btn-primary" onclick="location.href='{% url 'user_profile:upload_media' %}'">Upload</button>
            <button type="button" class="btn btn-primary" onclick="location.href='{% url 'user_profile:following_media' %}'">Following Media</button>
            <button type="button" class="btn btn-primary" onclick="location.href='{% url 'user_profile:edit_profile' user_id=request.user.id %}'">Edit Profile</button>
        </div>
    </div>
{% endif %}

<h2>{{ media.user.username }}'s Other Uploads</h2>
<div class="row row-cols-1 g-4">
    {% for upload in page_obj %}
        <div class="col">
            <div id="media-container-{{ upload.id }}" class="upload-item">
                <a href="{% url 'user_profile:media_detail_view' upload.id %}">
                    {% if upload.file.url|is_video %}
                        <video controls class="img-fluid autoplay-video" muted>
                            <source src="{{ upload.file.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    {% else %}
                        <img src="{{ upload.file.url }}" alt="Image" class="img-fluid">
                    {% endif %}
                </a>

                <!-- View Count -->
                <div class="view-count">
                    <p>Views: {{ upload.view_count }}</p>
                </div>

                <!-- Description with clickable links -->
                <div class="description">
                    <p>{{ upload.description|safe }}</p>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<!-- Pagination Controls -->
<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}">Previous</a>
    {% endif %}

    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">Next</a>
    {% endif %}
</div>

{% endblock %}

{% block media_detail_script %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Setup Intersection Observer for videos
        const videos = document.querySelectorAll('.autoplay-video');
        const observerOptions = {
            root: null,
            threshold: 0.75 // Play video when 50% of it is visible
        };

        const videoObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                const video = entry.target;
                if (entry.isIntersecting) {
                    video.play();
                } else {
                    video.pause();
                }
            });
        }, observerOptions);

        videos.forEach(video => {
            videoObserver.observe(video);
        });

        // Existing like button functionality
        function handleLikeButtonClick(event) {
            event.preventDefault();
            const likeLink = event.currentTarget;
            const url = likeLink.getAttribute('data-url');
            const csrfToken = likeLink.getAttribute('data-csrf-token');

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                const likeCount = likeLink.nextElementSibling;
                likeCount.textContent = data.like_count;
                if (data.liked) {
                    likeLink.classList.add('liked');
                    likeLink.textContent = '❤️';
                } else {
                    likeLink.classList.remove('liked');
                    likeLink.textContent = '♡';
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        document.querySelectorAll('.like-link').forEach(function(link) {
            link.addEventListener('click', handleLikeButtonClick);
        });

        // Comment form submission logic (remains the same)
    });
</script>
{% endblock %}


{% comment %} let page = 1;
    const mediaDetailUrl = "{% url 'user_profile:media_detail_view' media.id %}";
    const otherUploadsContainer = document.getElementById('other-uploads');
    const loadingSpinner = document.getElementById('loading-spinner');

    function fetchMoreUploads() {
        page += 1;
        loadingSpinner.style.display = 'block';

        fetch(`${mediaDetailUrl}?page=${page}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.style.display = 'none';

            if (data.related_media.length > 0) {
                data.related_media.forEach(upload => {
                    const uploadItem = document.createElement('div');
                    uploadItem.classList.add('upload-item');
                    uploadItem.onclick = function() {
                        // Correctly generate the URL using the media ID from the response
                        const url = "{% url 'user_profile:media_detail_view' '0' %}".replace('0', upload.id);
                        window.location.href = url;
                    };

                    if (upload.is_video) {
                        const video = document.createElement('video');
                        video.controls = true;
                        video.style.maxWidth = '100%';
                        video.style.height = 'auto';

                        const source = document.createElement('source');
                        source.src = upload.file_url;
                        source.type = 'video/mp4';

                        video.appendChild(source);
                        uploadItem.appendChild(video);
                    } else {
                        const img = document.createElement('img');
                        img.src = upload.file_url;
                        img.alt = 'Image';
                        img.style.maxWidth = '100%';
                        img.style.height = 'auto';

                        uploadItem.appendChild(img);
                    }

                    otherUploadsContainer.appendChild(uploadItem);
                });
            } else {
                window.removeEventListener('scroll', handleScroll);
            }
        })
        .catch(error => {
            console.error('Error fetching more uploads:', error);
            loadingSpinner.style.display = 'none';
        });
    }

    function handleScroll() {
        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;

        if (scrollTop + clientHeight >= scrollHeight - 5) {
            fetchMoreUploads();
        }
    }

    window.addEventListener('scroll', handleScroll);

    fetchMoreUploads(); {% endcomment %}