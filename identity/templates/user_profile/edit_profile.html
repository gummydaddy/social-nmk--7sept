{% extends 'landing_page.html' %}
{% load static %}

{% comment %} {% block main_content %}
<div class="container">
    <h2>Edit Profile</h2>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Save changes</button>
        <button type="button" class="btn btn-primary" id="privacy-button" data-private="{{ request.user.profile.is_private|yesno:'Private,Public' }}">
            {{ request.user.profile.is_private|yesno:'Private,Public' }}
        </button>
        <div class="text-center mt-4">
            <a href="/password_reset/" class="btn btn-primary">Reset Password</a>
        </div>
    </form>
</div>
{% endblock %} {% endcomment %}
{% block main_content %}
<div class="container">
    <h4>Edit Profile</h4>

    <button type="button" class="btn btn-primary" id="privacy-button" data-private="{{ request.user.profile.is_private|yesno:'Private,Public' }}">
        {{ request.user.profile.is_private|yesno:'Private,Public' }}
    </button>
    </br>

    <!-- Form for Profile Picture, Cover Photo, and Username -->
    <form method="post" enctype="multipart/form-data" action="{% url 'user_profile:edit_profile' user_id=profile_user.id %}">
        {% csrf_token %}
        
        <!-- Profile Form -->
        {% comment %} <h3>Profile Information</h3>
        {{ form.profile_picture.label_tag }} {{ form.profile_picture }}
        {{ form.cover_photo.label_tag }} {{ form.cover_photo }}
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" name="save_changes">Save Changes</button>
        </form> {% endcomment %}
        
        <!-- Profile Form -->
        <h4>Profile Information</h4>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.profile_picture.label_tag }} {{ form.profile_picture }}
            </br>
            {{ form.cover_photo.label_tag }} {{ form.cover_photo }}
            </br>
            <div class="mt-4">
                <button type="submit" class="btn btn-primary" name="save_changes">Save Changes</button>
            </div> 
        </form>
        </br>
    <!-- Username Form -->
        <form method="post">
            {% csrf_token %}
            {{ username_form.as_p }}
            <button type="submit" class="btn btn-primary" name="update_username">Update Username</button>
        </form>

        <!-- Submit Button for Profile and Username -->
        {% comment %} 
            <button type="submit" class="btn btn-primary">Save changes</button>
       {% endcomment %}
    </form>

    <hr>

    <!-- Separate Form for Bio -->
    <form method="post" action="{% url 'user_profile:save_bio' %}">
        {% csrf_token %}

        <!-- Bio Section -->
        <h3 class="mt-4">Update Bio</h3>
        {{ form.bio.label_tag }} {{ form.bio }}

        <!-- Submit Button for Bio -->
        <div class="mt-4">
            <button type="submit" class="btn btn-primary">Save Bio</button>
        </div>
    </form>

    <!-- Password Reset Link -->
    <div class="text-center mt-4">
        <a href="{% url 'user_profile:password_reset' %}" class="btn btn-primary">Reset Password</a>
    </div>

    <!-- Display Messages -->
    {% if messages %}
    <ul class="mt-4">
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
    </ul>
    {% endif %}
</div>
{% endblock %}


{%block edit_profile_script%}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const privacyButton = document.getElementById('privacy-button');
    
        if (privacyButton) {
            privacyButton.addEventListener('click', function() {
                const url = "{% url 'user_profile:toggle_privacy' %}";
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        privacyButton.textContent = data.is_private ? 'Private' : 'Public';
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        }
    });
    
</script>
{%endblock%}