{% extends 'landing_page.html' %}
{% load static %}
{% load custom_filters_message %}
{% load media_filters %}

{% block main_content %}
<style>
    .message-container {
        width: 100%;
        height: 60vh;
        border: 1px solid #ccc;
        background-color: #fff0ff;
        overflow-y: scroll;
        padding: 10px;
        margin-bottom: 20px;
        color: #123;
    }

    .message-container ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .message-container ul li {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
        max-width: 60%;
        font-size: 12px;
    }

    .sender-message {
        background-color: #e1ffc7;
        text-align: right;
        margin-left: auto;
    }

    .recipient-message {
        background-color: #f1f1f1;
        text-align: left;
        margin-right: auto;
    }

    form {
        margin-top: 5px;
        margin-bottom: 5px;
    }
</style>

<h2>{{ recipient.username }}</h2>

<div id="chat-box" class="message-container" data-recipient="{{ recipient.username }}">
    <ul id="message-list">
        {% for message in messages %}
        <li class="{% if message.sender.username == recipient.username %}recipient-message{% else %}sender-message{% endif %}">
            {% if message.file_url %}
                {% if message.file_url|is_video %}
                    <video controls class="img-fluid">
                        <source src="{{ message.file_url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                {% elif message.file_url|is_image %}
                    <img src="{{ message.file_url }}" alt="media" class="img-fluid">
                {% else %}
                    <a href="{{ message.file_url }}" download>Download file</a><br>
                {% endif %}
            {% else %}
                {{ message.content|make_clickable }}<br>
            {% endif %}
            <em>{{ message.timestamp }}</em>
        </li>
        {% endfor %}
    </ul>
</div>

<form id="chat-message-form" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Send ➣➤</button>
</form>

<h5>File sharing coming soon</h5>
{% endblock %}

{% block Message_script %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatBox = document.getElementById('chat-box');
        const recipientUsername = chatBox.dataset.recipient;
        const messageList = document.getElementById('message-list');
        const messageForm = document.getElementById('chat-message-form');
        const contentInput = document.getElementById('id_content');
        const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        const chatSocket = new WebSocket(`${ws_scheme}://${window.location.host}/ws/chat/${recipientUsername}/`);

        // Scroll to bottom on load
        chatBox.scrollTop = chatBox.scrollHeight;

        chatSocket.onopen = function () {
            console.log("WebSocket connection opened.");
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            if (data.message && data.sender) {
                const currentUser = "{{ request.user.username }}";
                const messageElement = document.createElement('li');
                messageElement.className = data.sender === currentUser ? 'sender-message' : 'recipient-message';
                messageElement.innerHTML = `${data.message} <em>${new Date().toLocaleTimeString()}</em>`;
                messageList.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            } else if (data.error) {
                alert(data.error);
            }
        };

        chatSocket.onerror = function (e) {
            console.error("WebSocket error:", e);
        };

        chatSocket.onclose = function () {
            console.warn("WebSocket connection closed.");
        };

        messageForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const message = contentInput.value.trim();
            if (!message) return;

            chatSocket.send(JSON.stringify({
                action: "send_message",
                recipient: recipientUsername,
                content: message
            }));

            contentInput.value = '';
        });
    });
</script>
{% endblock %}
