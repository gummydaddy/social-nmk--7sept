{% extends 'landing_page.html' %}
{% load static %}
{% load custom_filters %}

{% block main_content %}
<style>

    .media-wrapper {
        max-width: none;
        width: 100%;
        margin: 0 auto;
        padding: 2px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        color: #123;
    }

    .media-content img,
    .media-content video {
        max-width: 100%;
        height: auto;
        object-fit: contain;
        border-radius: 8px;
        display: block;
        margin: 0 auto;
    }

    .img-fluid {
        max-width: 100%;
        height: auto;
    }

    p {
        margin-top: 0;
        margin-bottom: 0rem;
    }

    .g-4, .gy-4 {
        --bs-gutter-y: 1.rem;
    }
    .g-4, .gx-4 {
        --bs-gutter-x: 1.rem;
    }

    {% comment %} .media-item + .media-item {
        margin-top: 5px;
    } {% endcomment %}
</style>

<form method="GET" action="{% url 'user_profile:search_uploads' %}" class="d-flex mb-4">
    <input type="text" name="q" class="form-control me-2" placeholder="Search descriptions, hashtags..." value="{{ request.GET.q }}">
    {% comment %} <input type="text" name="hashtag" class="form-control me-2" placeholder="Filter by hashtag" value="{{ request.GET.hashtag }}"> {% endcomment %}
    <button type="submit" class="btn btn-primary">Search</button>
</form>


<br>

<div class="media-wrapper">
    <div class="row row-cols-3 g-4" id="media-container">
        {% for media in page_obj %}
            <div class="col media-item">
                <a href="{% url 'user_profile:explore_detail' media.id %}" class="media-content">
                    {% if media.thumbnail %}
                        <img src="{{ media.thumbnail.url }}" alt="Thumbnail" class="img-fluid" loading="lazy">
                    {% else %}
                        <img src="{{ media.file.url }}" alt="media" class="img-fluid" loading="lazy">
                    {% endif %}
                </a>
            </div>
        {% endfor %}
    </div>
</div>


<!-- Loading Spinner -->
<div id="loading-spinner" style="display: none;">
    {% comment %} <img src="{% static 'img/loading_spinner.gif' %}" alt="Loading..."> {% endcomment %}
</div>

<!-- Media Detail Modal -->
<div id="media-detail-modal" class="modal fade" tabindex="-1" aria-labelledby="mediaDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mediaDetailModalLabel">Media Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Media detail content will be loaded here -->
                <div id="media-detail-content"></div>
                <div id="related-media-container" class="row row-cols-3 g-4 mt-4">
                    <!-- Related media will be appended here -->
                </div>
                <div id="related-loading-spinner" style="display: none;">
                    {% comment %} <img src="{% static 'img/loading_spinner.gif' %}" alt="Loading..."> {% endcomment %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pagination controls -->
<div class="pagination">
    <span class="step-links">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if hashtag_filter %}&hashtag={{ hashtag_filter }}{% endif %}">&laquo; first</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if hashtag_filter %}&hashtag={{ hashtag_filter }}{% endif %}">previous</a>
        {% endif %}
        <span class="current">
            <br>
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
        </span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if hashtag_filter %}&hashtag={{ hashtag_filter }}{% endif %}">next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if hashtag_filter %}&hashtag={{ hashtag_filter }}{% endif %}">last &raquo;</a>
        {% endif %}
    </span>
</div>

            {% block footer %}
            <footer style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border-top: 1px solid #e5e7eb;" class="text-center py-3">
                <div class="bottom-strip d-flex justify-content-around align-items-center">

                    <div class="footer-icon">
                        <a href="{% url 'user_profile:following_media'  %}">
                            <i class="fas fa-home"></i>
                        </a>
                    </div>

                    <div class="footer-icon">
                        <a href="{% url 'only_card:landing_page' %}">
                            <i class="fas fa-shield-alt"></i>
                        </a>
                    </div>

                    <div class="footer-icon">
                        <a href="{% url 'notion:notion_home' notion_id=request.user.id %}">
                            <i class="fas fa-lightbulb"></i>
                        </a>
                    </div>

                    <div class="footer-icon">
                        <a href="{% url 'user_profile:explore' %}">
                            <i class="fas fa-globe"></i>
                        </a>
                    </div>

                    <div class="footer-icon">
                        <a href="{% url 'user_profile:profile' user_id=request.user.id %}">
                            <i class="fas fa-user-circle"></i>
                        </a>
                    </div>

                </div>
            </footer>

            {% endblock %}

{% endblock %}

{% block script %}
<script>
    const mediaContainer = document.getElementById('media-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    let page = {{ page_obj.number }};
    let loading = false;
    let hasNext = {{ page_obj.has_next|yesno:"true,false,false" }};
    const scrollThreshold = 200; // Load when within 200px of the bottom

    function log(message, ...args) {
        console.log('[InfiniteScroll]', message, ...args);
    }

    function fetchMoreMedia() {
        if (loading || !hasNext) {
            log('fetchMoreMedia called, but returning early', { loading, hasNext });
            return;
        }
        loading = true;
        page += 1;

        const url = new URL(window.location.href);
        const q = url.searchParams.get('q') || '';

        log('Fetching page:', page, 'with query:', q);
        loadingSpinner.style.display = 'block';

        fetch(`?page=${page}&q=${q}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                log('fetchMoreMedia response not OK:', response.status);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            loadingSpinner.style.display = 'none';
            log('fetchMoreMedia success:', data);

            if (data.media && data.media.length > 0) {
                data.media.forEach(media => {
                    const col = document.createElement('div');
                    col.classList.add('col', 'media-item');

                    const link = document.createElement('a');
                    link.href = `/user_profile/explore_detail/${media.id}/`;

                    if (media.is_video) {
                        const video = document.createElement('video');
                        video.controls = true;
                        video.classList.add('img-fluid');
                        const source = document.createElement('source');
                        source.src = media.file_url;
                        source.type = 'video/mp4';
                        video.appendChild(source);
                        video.loading = 'lazy'; // Lazy load video (browser support varies)
                        link.appendChild(video);
                    } else {
                        const img = document.createElement('img');
                        img.src = media.file_url;
                        img.alt = 'media';
                        img.classList.add('img-fluid');
                        img.loading = 'lazy'; // Lazy load image
                        link.appendChild(img);
                    }

                    col.appendChild(link);
                    mediaContainer.appendChild(col);
                });
                hasNext = data.has_next;
                log('hasNext updated:', hasNext);
            } else {
                log('No more media received or data.media is empty');
                hasNext = false;
                window.removeEventListener('scroll', handleScroll);
                const endMessage = document.createElement('div');
                endMessage.classList.add('col-12', 'text-center', 'my-4');
                endMessage.textContent = 'No more media to load.';
                mediaContainer.appendChild(endMessage);
            }
        })
        .catch(error => {
            log('fetchMoreMedia error:', error);
            loadingSpinner.style.display = 'none';
            loading = false;
        });
    }

    function handleScroll() {
        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
        const bottomReachedRaw = scrollTop + clientHeight;
        const scrollBottomThreshold = scrollHeight - scrollThreshold;
        const bottomReached = bottomReachedRaw >= scrollBottomThreshold;

        log('Scroll Event:', { scrollTop, scrollHeight, clientHeight, bottomReachedRaw, scrollBottomThreshold, bottomReached, loading, hasNext });

        if (bottomReached && !loading && hasNext) {
            log('Bottom of page reached, calling fetchMoreMedia');
            fetchMoreMedia();
        }
    }

    window.addEventListener('scroll', handleScroll);
    log('Scroll event listener attached');
</script>
{% endblock %}


