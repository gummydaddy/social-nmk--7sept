{% extends "landing_page.html" %}
{% load static %}

{% block main_content %}
<style>
    .select2-container {
        width: 100% !important;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .progress-bar {
        background-color: #4CAF50; /* Green */
        color: white;
        text-align: center;
        line-height: 20px; /* Adjust to your progress bar height */
        width: 0%;
        height: 20px; /* Adjust as needed */
        border-radius: 5px;
        margin-top: 5px;
    }

</style>

<h2>Upload</h2>
<h6>the "video" upload function is not availabe currently</h6>
<form id="uploadForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <div class="form-group">
        <label for="id_file">image</label>
        <input type="file" class="form-control-file" id="id_file" name="file" accept="image/*, video/*" onchange="previewFile(event)">
        {% for error in form.file.errors %}
            <p class="help-block text-danger">{{ error }}</p>
        {% endfor %}
        <div id="filePreview" class="mt-3"></div>
    </div>
    <div id="videoOptions" class="form-group" style="display:none;">
        <label for="id_start_time">Start Time (seconds)</label>
        <input type="number" class="form-control" id="id_start_time" name="start_time" min="0" value="0">
        <label for="id_duration">Duration (seconds)</label>
        <input type="number" class="form-control" id="id_duration" name="duration" min="1" value="90">
    </div>
    <div class="form-group">
        <label for="id_filter">Filter</label>
        <select class="form-control" id="id_filter" name="filter">
            <option value="">Select a filter</option>
            <option value="clarendon">Clarendon</option>
            <option value="sepia">Sepia</option>
            <option value="grayscale">Grayscale</option>
            {% comment %} <option value="invert">Invert</option> {% endcomment %}
        </select>
    </div>
    <div class="form-group">
        <label for="id_tags">Tag Users</label>
        {{ form.tags }}  <!-- This is where the Select2 widget will be applied -->
    </div>
    <div class="form-group">
        <label for="id_description">Description</label>
        <textarea class="form-control" id="id_description" name="description" rows="3" oninput="convertLinks(event)"></textarea>
        {% for error in form.description.errors %}
            <p class="help-block text-danger">{{ error }}</p>
        {% endfor %}
        <div id="descriptionPreview" class="mt-3"></div>
    </div>
    <button type="submit" class="btn btn-primary" id="submitButton">Upload</button>
    <div id="uploadSpinner" style="display:none;">Uploading...</div>
    <div id="uploadProgress" style="display:none;">
        <div class="progress-bar" style="width: 0%;">0%</div>
    </div>
    <div id="uploadStatus"></div>

</form>
<!--
<div id="uploadingSpinner" style="display:none; text-align: center; margin-top: 10px;">
    <div class="spinner" style="width: 40px; height: 40px; border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <p style="margin-top: 10px; color: #007bff;">Uploading... Please wait.</p>
</div>
-->
                    <div class="home bg-white">
                        <a href="{% url 'user_profile:add_story' %}">
                            <i class="fas fa-upload"></i>
                            <div>Add Story</div>
                        </a>
                    </div>
{% endblock %}

{% block upload_script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Tag user field with Select2
        $('#id_tags').select2({
            ajax: {
                url: '{% url "user_profile:tag_user_search" %}',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return { q: params.term };
                },
                processResults: function(data) {
                    return { results: data.results };
                },
                cache: true
            },
            minimumInputLength: 1,
            placeholder: 'Search for users to tag...',
            allowClear: true,
        });
    });

    function previewFile(event) {
        const input = event.target;
        const previewContainer = document.getElementById('filePreview');
        previewContainer.innerHTML = '';

        const file = input.files[0];
        if (file) {
            const fileType = file.type;
            const previewElement = document.createElement(fileType.startsWith('image/') ? 'img' : 'video');

            previewElement.src = URL.createObjectURL(file);
            previewElement.style.maxWidth = '100%';
            previewElement.style.maxHeight = '400px';

            if (fileType.startsWith('video/')) {
                previewElement.controls = true;
                document.getElementById('videoOptions').style.display = 'block';
            } else {
                document.getElementById('videoOptions').style.display = 'none';
            }

            previewContainer.appendChild(previewElement);
        }
    }

    function convertLinks(event) {
        const input = event.target;
        const previewContainer = document.getElementById('descriptionPreview');
        previewContainer.innerHTML = '';

        const text = input.value;
        const linkifiedText = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
        previewContainer.innerHTML = linkifiedText;
    }
</script>


<script>
$(document).ready(function() {
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault(); // Stop normal form submission

        $('#uploadSpinner').show();        // Show spinner
        $('#submitButton').prop('disabled', true); // Disable button
        $('#uploadProgress').show();       // Show progress bar
        $('#uploadStatus').text('');       // Clear any previous status

        const form = this;
        const formData = new FormData(this);

        $.ajax({
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress", function(evt) {
                    if (evt.lengthComputable) {
                        const percentComplete = Math.round((evt.loaded / evt.total) * 100);
                        $('#uploadProgress .progress-bar').css('width', percentComplete + '%').text(percentComplete + '%');
                    }
                }, false);
                return xhr;
            },
            url: '{% url "user_profile:upload_media" %}', // Your media upload view
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'  

            },
            success: function(response) {
                console.log('Upload successful:', response);
                alert("Upload successful!");
                window.location.href = "{% url 'user_profile:profile' request.user.id %}";

            },
            error: function(xhr, status, error) {
                $('#uploadSpinner').hide();           // Hide spinner
                $('#uploadProgress').hide();          // Hide progress bar
                $('#submitButton').prop('disabled', false); // Re-enable button
                $('#uploadStatus').text("Upload failed. Please try again.");
                console.error("Upload error:", error);
            }
        });
    });
});
</script>

{% endblock %}


